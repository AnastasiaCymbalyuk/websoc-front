(()=>{"use strict";class e{showModal(){this.createModal(),document.body.appendChild(this.modal),this.buttonСontinue=this.modal.querySelector(".form__button"),this.buttonСontinue.addEventListener("click",this.onSaveName)}onSaveName(e){e.preventDefault();let{modal:t}=this.modal;const s=t.querySelector(".form__text");if(this.name=s.value,""===this.name)return s.style.background="#dba1a1",void setTimeout((()=>{s.style.background="#fdfdfd"}),800);this.onStart(),document.body.removeChild(t),t=null}createModal(){this.modal=document.createElement("div"),this.modal.classList.add("modal"),this.warning?setTimeout((()=>{this.modal.querySelector(".warning").classList.add("hidden")}),2e3):this.warning="",this.modal.innerHTML=`\n        <div class="modal__wrapper">\n          <div class="modal__content">\n            <h3 class="modal__title">Выберите псевдоним</h3>\n            <form class="form">\n                <textarea type="text" class="form__text " required></textarea>\n                <button class="form__button button button-continue">продолжить</button>\n                <div class='warning'>${this.warning}</div>\n            </form> \n          </div>\n        </div>\n        `,this.warning=""}}const t=document.querySelector(".chat");new class{constructor(t){this.element=t,this.userList=this.element.querySelector(".chat__users-list"),this.textArea=this.element.querySelector(".chat__messages-text"),this.messagesBox=this.element.querySelector(".chat__messages-messages"),this.server="wss://websoc-back.herokuapp.com/ws",this.onStart=this.onStart.bind(this),this.modal=new e,this.modal.showModal=this.modal.showModal.bind(this.modal),this.modal.createModal=this.modal.createModal.bind(this.modal),this.modal.onSaveName=this.modal.onSaveName.bind(this)}init(){this.modal.showModal()}onStart(){this.ws=new WebSocket(this.server),this.ws.addEventListener("open",(()=>{this.ws.send(JSON.stringify({event:"connected",message:this.name}))})),this.ws.addEventListener("message",(e=>{const t=JSON.parse(e.data);"connect"===t.event&&(this.users=t.message),"system"===t.event&&(this.users=t.message.users,this.renderUserList()),"message"===t.event&&this.addMsg(t.message)})),this.ws.addEventListener("close",(e=>{e.reason&&(this.modal.warning=e.reason,this.modal.showModal())})),this.textArea.addEventListener("keydown",(e=>{const t=this.textArea.value.trim();"Enter"===e.key&&t&&(e.preventDefault(),this.textArea.value="",this.sendMsg(t))}))}renderUserList(){this.userList.textContent="",this.users.forEach((e=>{const t=document.createElement("li");t.classList.add("chat__users-user"),t.textContent=e,e===this.name&&(t.textContent="You",t.classList.add("you")),this.userList.appendChild(t)}))}sendMsg(e){this.ws.send(JSON.stringify({event:"message",message:e}))}addMsg(e){let{name:t}=e;const{text:s}=e;t===this.name&&(t="You");const a=function(e){let t=new Date(e);return t=t.toLocaleString("ru"),t=t.substr(0,17).replace(",",""),t}(e.date),n=document.createElement("div");n.classList.add("message"),n.innerHTML=`\n    <div class="message__information">${t}, ${a}</div>\n    <div class="message__text">${s}</div>\n    `,"You"===t&&n.classList.add("your-message"),this.messagesBox.appendChild(n);const i=this.element.querySelector(".chat__messages-wrapper");i.scrollTop=i.scrollHeight}}(t).init()})();